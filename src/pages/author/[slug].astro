---
import { getUsers, getUserBySlug, getPosts, getLocalFeaturedImageUrl, formatDate } from '../../lib/wordpress';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import FeaturedImage from '../../components/FeaturedImage.astro';

export async function getStaticPaths() {
  const users = await getUsers();
  return users.map(user => ({
    params: { slug: user.slug },
  }));
}

const { slug } = Astro.params;
const author = await getUserBySlug(slug);

if (!author) {
  return Astro.redirect('/404');
}

const allPosts = await getPosts({ perPage: 100 });
const posts = allPosts.filter(post => post.author === author.id);
---

<BaseLayout title={`${author.name} - Author`}>
  <Header />
  <main id="main-content" class="container mx-auto px-4 py-8 bg-surface">
    <div class="flex items-center gap-4 mb-8">
      {author.avatar_urls?.['96'] && (
        <img 
          src={author.avatar_urls['96']} 
          alt={author.name}
          width={96}
          height={96}
          class="w-24 h-24 rounded-full"
        />
      )}
      <div>
        <h1 class="text-4xl font-bold text-content">{author.name}</h1>
        {author.description && (
          <p class="text-content-light mt-2">{author.description}</p>
        )}
      </div>
    </div>
    
    <h2 class="text-2xl font-semibold mb-6 text-content">Posts by {author.name}</h2>
    
    <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
      {posts.map(post => {
        const postImage = getLocalFeaturedImageUrl(post);
        return (
          <a href={`/blog/${post.slug}`} class="block bg-surface rounded-lg shadow-md overflow-hidden border border-outline hover:shadow-lg transition-shadow cursor-pointer">
            {postImage && (
              <FeaturedImage src={postImage} alt={post.title.rendered} width={400} height={225} class="w-full h-48 object-cover" />
            )}
            <div class="p-6">
              <h3 class="text-xl font-semibold mb-2 text-content" set:html={post.title.rendered} />
              <p class="text-content-lighter text-sm mb-2">{formatDate(post.date)}</p>
              <div class="text-content-light line-clamp-3" set:html={post.excerpt.rendered} />
            </div>
          </a>
        );
      })}
    </div>
    
    {posts.length === 0 && (
      <p class="text-content-lighter text-center py-12">No posts by this author yet.</p>
    )}
  </main>
  <Footer />
</BaseLayout>
